#!/usr/bin/expect -f

proc expect_or_fail {pattern} {
    expect {
        timeout {
            puts "FAIL: timeout waiting for: $pattern"
            exit 1
        }
        eof {
            puts "FAIL: unexpected EOF waiting for: $pattern"
            exit 1
        }
        $pattern
    }
}

set timeout 10

spawn ./schmeep
expect_or_fail "scheme> "

send "(+ 100 20 3)\r"
expect_or_fail "123"
expect_or_fail "scheme> "

send "(/ 1 0)\r"
expect_or_fail "Exception: divide by zero"
expect_or_fail "scheme> "

send "(begin (display \"alpha bravo charlie\\n\") 234)\r"
expect_or_fail "alpha bravo charlie"
expect_or_fail 234
expect_or_fail "scheme> "

send "(begin (write \"delta echo\") (newline) 345)\r"
expect_or_fail "delta echo"
expect_or_fail 345
expect_or_fail "scheme> "

send "(let loop () (loop))\r"
sleep 5

send "\003"
expect_or_fail "Interrupted"
expect_or_fail "scheme> "

send "(+ 400 50 6)\r"
expect_or_fail "456"
expect_or_fail "scheme> "

close

spawn ./schmeep
expect_or_fail "scheme> "

send "(+ 500 60 7)\r"
expect_or_fail "567"
expect_or_fail "scheme> "

close

puts "ALL PASSED."
